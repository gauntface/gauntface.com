<!DOCTYPE html><html lang="en"><head>
  <title>Perf Wars: Gaunt Face vs Aerotwist</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="Description" content="This is the site description"/>
  <meta name="theme-color" content="#565797"/>
<style>code{padding:0 4px;font-family:var(--code-font-family);background:var(--pale-chestnut)}</style><style>pre{overflow-x:auto}</style><style>pre{background-color:var(--dark);color:var(--light);padding:12px;overflow-x:auto;border-radius:12px;box-shadow:0 2px 8px var(--drop-shadow)}pre code{padding:0;background:unset}</style><style>img{max-width:100%;height:auto}</style><style>svg{display:block}</style><style>p{word-wrap:break-word}</style><style>@import url("https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap");body{display:inline;min-height:100%;font-family:var(--body-font-family);background:var(--platnum);margin:0}</style><style>.c-header{color:var(--platnum);padding:var(--header-padding) var(--page-padding);background:var(--liberty)}.c-header__logo svg{width:124px;height:124px;margin:auto}.c-header__logo svg path{fill:var(--platnum)}</style><style>.l-default{display:flex;flex-direction:column;min-height:100%}.l-default__main{flex:1;padding:var(--page-padding)}</style><style>:root{--body-font-family:"Roboto",sans-serif;--code-font-family:"dm",monospace;--default-font-size:18px;--table-cell-padding:8px;--page-padding:24px;--header-padding:64px;--white-smoke:#f7f7f7;--platnum:#e5dedf;--dust-storm:#e5c9cf;--pale-chestnut:#e5a9b4;--liberty:#565797;--dark-slate-blue:#434596;--lightest:#d0d0d0;--light:#bfc7d4;--muted-light:#747a88;--muted:#434757;--dark:#292d3d;--black:#272729;--drop-shadow:rgba(39,39,41,0.4);--red:#ee727a;--green:#c4e791;--yellow:#feca72;--blue:#84acfc;--purple:#c694e8;--light-blue:#8cddfd}html{height:100%;font-size:18px;font-size:var(--default-font-size)}</style><style>h1{font-size:2rem}</style><style>.c-footer{display:flex;flex-direction:row}.c-footer__corner{flex:1}.c-footer__corner svg{display:block;width:80%;height:100%;margin-left:auto}.c-footer__content{flex:2;margin-left:auto;background:var(--liberty)}@media (min-width:1000px){.c-footer{width:80%;margin-left:auto}}</style><style>h2{font-size:1.7rem}</style></head><body>
<div class="l-default">
  <header class="c-header">
  <a href="/" class="c-header__logo">
    <svg width="1024" height="1024" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M988 36H36V987H988V36ZM0 0V1023H1024V0H0Z" fill="black"></path>
<path d="M834.787 519.358H767.661V590H746.567V430.039H845.664V447.397H767.661V502.109H834.787V519.358Z" fill="black"></path>
<path d="M574.089 447.397H522.673V590H501.689V447.397H450.383V430.039H574.089V447.397Z" fill="black"></path>
<path d="M834.984 821.062H765.661V877.751H846.19V895H744.567V735.039H845.092V752.397H765.661V803.813H834.984V821.062Z" fill="black"></path>
<path d="M575.23 844.243C573.253 861.162 566.991 874.236 556.444 883.464C545.97 892.62 532.018 897.197 514.586 897.197C495.689 897.197 480.528 890.422 469.103 876.873C457.75 863.323 452.074 845.195 452.074 822.49V807.109C452.074 792.241 454.71 779.167 459.984 767.888C465.331 756.609 472.875 747.966 482.616 741.96C492.357 735.881 503.636 732.842 516.454 732.842C533.446 732.842 547.069 737.603 557.323 747.124C567.577 756.572 573.546 769.683 575.23 786.455H554.027C552.196 773.711 548.204 764.482 542.052 758.77C535.973 753.057 527.44 750.2 516.454 750.2C502.977 750.2 492.394 755.181 484.703 765.142C477.086 775.103 473.277 789.275 473.277 807.659V823.149C473.277 840.508 476.903 854.314 484.154 864.568C491.405 874.822 501.549 879.949 514.586 879.949C526.305 879.949 535.277 877.312 541.502 872.039C547.801 866.692 551.976 857.427 554.027 844.243H575.23Z" fill="black"></path>
<path d="M266.397 853.252H199.38L184.329 895H162.576L223.66 735.039H242.117L303.311 895H281.668L266.397 853.252ZM205.752 835.894H260.135L232.889 761.077L205.752 835.894Z" fill="black"></path>
<path d="M294.004 590H272.8L192.271 466.733V590H171.067V430.039H192.271L273.02 553.855V430.039H294.004V590Z" fill="black"></path>
<path d="M848.177 122.039V230.804C848.104 245.892 843.343 258.233 833.895 267.828C824.52 277.422 811.775 282.806 795.662 283.978L790.059 284.197C772.554 284.197 758.602 279.473 748.201 270.025C737.801 260.577 732.527 247.576 732.381 231.023V122.039H753.255V230.364C753.255 241.937 756.441 250.945 762.813 257.391C769.185 263.763 778.267 266.949 790.059 266.949C801.998 266.949 811.116 263.763 817.415 257.391C823.787 251.019 826.973 242.046 826.973 230.474V122.039H848.177Z" fill="black"></path>
<path d="M545.897 240.252H478.88L463.829 282H442.076L503.16 122.039H521.617L582.811 282H561.168L545.897 240.252ZM485.252 222.894H539.635L512.389 148.077L485.252 222.894Z" fill="black"></path>
<path d="M292.17 261.016C286.75 268.78 279.169 274.603 269.428 278.484C259.76 282.293 248.481 284.197 235.59 284.197C222.553 284.197 210.981 281.158 200.874 275.079C190.766 268.926 182.929 260.21 177.363 248.931C171.87 237.652 169.05 224.578 168.903 209.71V195.757C168.903 171.661 174.506 152.984 185.712 139.727C196.992 126.47 212.812 119.842 233.173 119.842C249.873 119.842 263.312 124.126 273.493 132.696C283.674 141.192 289.899 153.277 292.17 168.951H271.076C267.121 147.784 254.523 137.2 233.283 137.2C219.147 137.2 208.417 142.181 201.093 152.142C193.842 162.029 190.18 176.385 190.107 195.208V208.282C190.107 226.226 194.208 240.508 202.412 251.128C210.615 261.675 221.711 266.949 235.7 266.949C243.61 266.949 250.532 266.07 256.464 264.312C262.397 262.554 267.304 259.588 271.186 255.413V219.488H234.162V202.349H292.17V261.016Z" fill="black"></path>
</svg>

  </a>
</header>
  <main class="l-default__main">
<p><img src="/images/blog/2014/05/24/lego-war.jpg" alt="Key art for blog post “Perf Wars: Gaunt Face vs Aerotwist “"/></p>
<h1 id="perf-wars-gaunt-face-vs-aerotwist">Perf Wars: Gaunt Face vs Aerotwist</h1>
<p>In the not so distant past…</p>
<blockquote>
<p>The second day running where it&#39;s started off by being mocked for my poor code.</p>
<p>— Matt Gaunt (@gauntface) <a href="https://twitter.com/gauntface/statuses/436076818698108928">February 19, 2014</a></p>
</blockquote>
<blockquote>
<p><a href="https://twitter.com/gauntface">@gauntface</a>: <a href="https://twitter.com/aerotwist">@aerotwist</a> must like it as you “do all the bad things”.</p>
<p>— Chris Banes (@chrisbanes) <a href="https://twitter.com/chrisbanes/statuses/436088063618732033">February 19, 2014</a></p>
</blockquote>
<blockquote>
<p><a href="https://twitter.com/chrisbanes">@chrisbanes</a> <a href="https://twitter.com/gauntface">@gauntface</a> He’s a one-man, walking, talking, cautionary tale.</p>
<p>— Paul Lewis (@aerotwist) <a href="https://twitter.com/aerotwist/statuses/436095477537570817">February 19, 2014</a></p>
</blockquote>
<h1 id="whats-that-all-about">…whats that all about?</h1>
<p>I&#39;ve started work on my new site and I was figuring out what kind of components and interactions I wanted. One of the nice wins of creating my site with components first, is that testing each component can be done, without getting mixed up with other issues else where in the page.</p>
<p>After a few hours of coding, the initial static version of my site was ripped apart and the makeshift component library was formed.</p>
<p><img src="/images/blog/2014/02/Screenshot-from-2014-02-28-135238.png" alt="Component List"/></p>
<p>This is where our story begins.</p>
<h1 id="wheres-the-perf">Where&#39;s the Perf?</h1>
<p>When I started to look at the navigation drawer, there were a few unusual janks at the start and end of the animations. The video below shows the kind of animations I was trying to create.</p>
<!-- raw HTML omitted -->
<h1 id="that-looks-easy-so-clearly-matt-is-an-idiot">That Looks Easy, so Clearly Matt is an Idiot.</h1>
<h2 id="z-index-woes">Z-Index Woes</h2>
<p>My first attempt was the basic / quick approach. Use the <em>left</em> CSS property to move the bar and use opacity to hide and show the background color.</p>
<p>Using the <em>left</em> CSS property is generally considered bad practice as the browser can&#39;t optimise for it as well as it could do if you used <em>transform: translateX()</em>, see <a href="http://www.paulirish.com/2012/why-moving-elements-with-translate-is-better-than-posabs-topleft/">Paul Irish&#39;s post on this topic</a> if you&#39;re curious.</p>
<p>Once I had made that change, I wanted to check the frame rate of the animations. You can see the first version of the navigation drawer here: <a href="http://staging.gauntface.co.uk/components/archive/v1/navdrawer">http://staging.gauntface.co.uk/components/archive/v1/navdrawer</a></p>
<p>Running the timeline, there were two issues, I had regular dips in frame rate to 30fps (Generally when animations start / end) and there were some big old paints.</p>
<p><img src="/images/blog/2014/02/Screenshot-from-2014-02-28-150032.png" alt="Screenshot of Chrome Timeline for the Navigation Drawer" title="1024"/></p>
<p>A personal pet peeve is the large clear bars in the timeline, which basically indicates that Chrome is doing something, but Chrome isn&#39;t quite sure what it is, or there is no meaningful way to show the data, so it&#39;s kind of a black box. Me being me, poked <a href="http://aerotwist.com/">Paul Lewis</a> and asked if he could give me a hand at figuring out what was up. We didn&#39;t look too hard, but since the bars were largely unfilled and chrome://tracing didn&#39;t have any obvious issues, it looked like a Chrome issue, so I reached out to an engineer, asked if they could help and we got a quick answer - I was flipping a Z-Index from -1 to 2 - <a href="https://code.google.com/p/chromium/issues/detail?id=344625">https://code.google.com/p/chromium/issues/detail?id=344625</a>.</p>
<p>Now, this was clearly not a proud moment for me, it was a hack I put in the static site and I hadn&#39;t thought to properly address the z-indexing in a manageable way. At least we know now that z-index twiddling can have performance issues (and they hide quite well in the timeline).</p>
<h2 id="got-99-problems-and-the-frame-rate-aint-one">Got 99 Problems and the Frame Rate Ain&#39;t One</h2>
<p>Needless to say, Mr Lewis was somewhat in shock that I had even put this in (hence the tweets). I moved on, fixed up the z-indexing issue and lo and behold I still wasn&#39;t hitting the dream 60fps. What gives?</p>
<p>Digging around, asking Paul what he thought. We started looking at how I had done the transitions, I optimised the little javascript I had, removed things from javascript that could be achieved in CSS, limited the scope of the CSS style changes by altering class names on individual elements rather than the body, yet the paints still lived on.</p>
<p>This was breaking point for me, I had enough, the web clearly wasn&#39;t up to this basic task and Paul had finished with me, clearly I had done something really nasty and hidden it thoroughly away.</p>
<p>Well persistent nagging meant Paul went away and produced this: <a href="http://jsbin.com/tiyoxobe/4/quiet/">http://jsbin.com/tiyoxobe/4/</a>. A lovely non-painting version of the drawer.</p>
<p><img src="/images/blog/2014/02/Screenshot-of-Paul-Lewis-Demo-Timeline.png" alt="Screenshot of Paul Lewis Demo Timeline" title="1024"/></p>
<p>In my head I imagine he was all like:</p>
<p><img src="/images/blog/2014/02/magnum.gif" alt="Magnum P.I. gif" title="200"/></p>
<h2 id="the-opacity-issue">The Opacity Issue</h2>
<p>Digging around the example, trying to figure what was different, when I spotted this little slice of insanity.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">opacity</span><span style="color:#f92672">:</span> <span style="color:#f92672">0</span>.<span style="color:#a6e22e">00001</span><span style="color:#f92672">;</span>
</code></pre></div><p>Who in their right mind does this? Well apparently <a href="http://aerotwist.com">Aerotwist</a> does because he&#39;s aware of an issue which basically kicks a view out of being regarded as a composited layer if the opacity is a value of 0 or 1.</p>
<p>Moving swiftly along, I put this change in my page along with moving from a background color with an alpha value to a solid color and reducing the opacity from 1 to something lower. Suddenly a much happier looking graph appeared with no large paints.</p>
<p><img src="/images/blog/2014/02/Screenshot-of-Timeline-without-Request-Animation-Frame.png" alt="Screenshot of Timeline without Request Animation Frame" title="1024"/></p>
<h1 id="final-thoughts">Final Thoughts</h1>
<p>This would have sucked far more than it already had done if I hadn&#39;t pulled everything out into a component, which is why I&#39;m pretty glad I started off with this approach and have since invested some more time in making it a bit easier to create, add and maintain components.</p>
<p>But this is terrifying from a web developer’s stand point (at least for me). Realistically I have nothing checking that my page is hitting 60fps as I develop and make changes, I have to specifically investigate if it’s an issue or not. If you then consider cases where it doesn’t look like it’s your fault even though it is (the z-index flip) and other cases where the sane option simply isn’t the best option for performance (i.e. opacity), it’s pretty hard to picture a 60fps world.</p>
<p>It feels like the web has managed to get by without anyone calling shenanigans on issues like this, hopefully that will change as the devices browsers run on are more constrained and the expectations of the web grow.</p>
<p>Finally: I wouldn’t recommend using the opacity hack, it’s horrible and will hopefully not be required in the short term: <a href="https://code.google.com/p/chromium/issues/detail?id=345267">https://code.google.com/p/chromium/issues/detail?id=345267</a></p>
<p>Performance can be achieved, but it’s not easy and obviously CSS, JS and DOM needs a lot more crafting than I initially gave it credit for.</p>
<p>#perfmatters</p>
<p>Orig. Photo: <a href="https://flic.kr/p/ARLeo">https://flic.kr/p/ARLeo</a></p>

</main>
<footer class="c-footer">
  <div class="c-footer__corner">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 135.467 135.467" preserveAspectRatio="none"><path d="M135.467 135.467h-82.55L134.937 0h.53z" fill="#565797"></path><path d="M135.07 0L53.049 135.467H39.688L121.707 0z" fill="#feca72"></path><path d="M121.84 0L39.82 135.467H26.458L108.48 0z" fill="#c4e791"></path><path d="M108.611 0l-82.02 135.467H13.229L95.25 0z" fill="#84acfc"></path><path d="M95.382 0l-82.02 135.467H0L82.02 0z" fill="#ee727a"></path></svg>
  </div>
  <div class="c-footer__content"></div>
</footer>
</div>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-155219449-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-155219449-1');
</script>

<script>var haCSS = haCSS || []; haCSS.push(...['/css/elements/code-async.css']);</script></body></html>