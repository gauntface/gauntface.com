<!DOCTYPE html><html lang="en"><head>
  <title>Raspberry Pi &lt;3 Node</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="Description" content="This is the site description"/>
  <meta name="theme-color" content="#565797"/>
<style>.c-footer{display:flex;flex-direction:row;justify-content:center}.c-footer__content{padding:var(--footer-padding)}.c-footer a{text-decoration:none}</style><style>p{word-wrap:break-word}</style><style>h2{font-weight:400;font-size:1.7rem}</style><style>:root{--body-font-family:"Roboto",sans-serif;--code-font-family:"dm",monospace;--default-font-size:18px;--table-cell-padding:8px;--page-padding:24px;--header-padding:64px;--footer-padding:64px;--inline-code-padding:4px;--pre-padding:4px;--page-max-width:800px;--white:#f5f6fa;--dark-grey:#2f3640}html{height:100%;font-size:18px;font-size:var(--default-font-size)}</style><style>.c-header{color:var(--platnum);padding:var(--header-padding) var(--page-padding);background:var(--dark-grey)}.c-header__logo svg{width:124px;height:124px;margin:auto}.c-header__logo svg path{fill:var(--white)}</style><style>@import url("https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap");body{display:inline;min-height:100%;font-family:var(--body-font-family);background:var(--white);color:var(--dark-grey);margin:0}</style><style>img{max-width:100%;height:auto}</style><style>.l-default{display:flex;flex-direction:column;min-height:100%}.l-default__main{max-width:var(--page-max-width);margin:0 auto;flex:1;padding:var(--page-padding)}</style><style>svg{display:block}</style><style>pre{overflow-x:auto}</style><style>pre{background-color:var(--dark-grey);padding:var(--pre-padding);border-radius:var(--pre-padding);overflow-x:auto;box-shadow:0 2px 8px var(--drop-shadow)}pre code{padding:0;background:unset}</style><style>code{padding:0 var(--inline-code-padding);border-radius:var(--inline-code-padding);font-family:var(--code-font-family);background:var(--dark-grey);color:var(--white)}</style><style>h1{font-weight:400;font-size:2rem}</style><style>h3{font-weight:400;font-size:1.4rem}</style><style>a{color:inherit}</style></head><body>
<div class="l-default">
  <header class="c-header">
  <a href="/" class="c-header__logo">
    <svg width="1024" height="1024" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M988 36H36V987H988V36ZM0 0V1023H1024V0H0Z" fill="black"></path>
<path d="M834.787 519.358H767.661V590H746.567V430.039H845.664V447.397H767.661V502.109H834.787V519.358Z" fill="black"></path>
<path d="M574.089 447.397H522.673V590H501.689V447.397H450.383V430.039H574.089V447.397Z" fill="black"></path>
<path d="M834.984 821.062H765.661V877.751H846.19V895H744.567V735.039H845.092V752.397H765.661V803.813H834.984V821.062Z" fill="black"></path>
<path d="M575.23 844.243C573.253 861.162 566.991 874.236 556.444 883.464C545.97 892.62 532.018 897.197 514.586 897.197C495.689 897.197 480.528 890.422 469.103 876.873C457.75 863.323 452.074 845.195 452.074 822.49V807.109C452.074 792.241 454.71 779.167 459.984 767.888C465.331 756.609 472.875 747.966 482.616 741.96C492.357 735.881 503.636 732.842 516.454 732.842C533.446 732.842 547.069 737.603 557.323 747.124C567.577 756.572 573.546 769.683 575.23 786.455H554.027C552.196 773.711 548.204 764.482 542.052 758.77C535.973 753.057 527.44 750.2 516.454 750.2C502.977 750.2 492.394 755.181 484.703 765.142C477.086 775.103 473.277 789.275 473.277 807.659V823.149C473.277 840.508 476.903 854.314 484.154 864.568C491.405 874.822 501.549 879.949 514.586 879.949C526.305 879.949 535.277 877.312 541.502 872.039C547.801 866.692 551.976 857.427 554.027 844.243H575.23Z" fill="black"></path>
<path d="M266.397 853.252H199.38L184.329 895H162.576L223.66 735.039H242.117L303.311 895H281.668L266.397 853.252ZM205.752 835.894H260.135L232.889 761.077L205.752 835.894Z" fill="black"></path>
<path d="M294.004 590H272.8L192.271 466.733V590H171.067V430.039H192.271L273.02 553.855V430.039H294.004V590Z" fill="black"></path>
<path d="M848.177 122.039V230.804C848.104 245.892 843.343 258.233 833.895 267.828C824.52 277.422 811.775 282.806 795.662 283.978L790.059 284.197C772.554 284.197 758.602 279.473 748.201 270.025C737.801 260.577 732.527 247.576 732.381 231.023V122.039H753.255V230.364C753.255 241.937 756.441 250.945 762.813 257.391C769.185 263.763 778.267 266.949 790.059 266.949C801.998 266.949 811.116 263.763 817.415 257.391C823.787 251.019 826.973 242.046 826.973 230.474V122.039H848.177Z" fill="black"></path>
<path d="M545.897 240.252H478.88L463.829 282H442.076L503.16 122.039H521.617L582.811 282H561.168L545.897 240.252ZM485.252 222.894H539.635L512.389 148.077L485.252 222.894Z" fill="black"></path>
<path d="M292.17 261.016C286.75 268.78 279.169 274.603 269.428 278.484C259.76 282.293 248.481 284.197 235.59 284.197C222.553 284.197 210.981 281.158 200.874 275.079C190.766 268.926 182.929 260.21 177.363 248.931C171.87 237.652 169.05 224.578 168.903 209.71V195.757C168.903 171.661 174.506 152.984 185.712 139.727C196.992 126.47 212.812 119.842 233.173 119.842C249.873 119.842 263.312 124.126 273.493 132.696C283.674 141.192 289.899 153.277 292.17 168.951H271.076C267.121 147.784 254.523 137.2 233.283 137.2C219.147 137.2 208.417 142.181 201.093 152.142C193.842 162.029 190.18 176.385 190.107 195.208V208.282C190.107 226.226 194.208 240.508 202.412 251.128C210.615 261.675 221.711 266.949 235.7 266.949C243.61 266.949 250.532 266.07 256.464 264.312C262.397 262.554 267.304 259.588 271.186 255.413V219.488H234.162V202.349H292.17V261.016Z" fill="black"></path>
</svg>

  </a>
</header>
  <main class="l-default__main">
<p><img src="/images/blog/2014/08/28/7223008454-955fbf0274-k.jpg" alt="Key art for blog post “Raspberry Pi &lt;3 Node “"/></p>
<h1 id="raspberry-pi-3-node">Raspberry Pi &lt;3 Node</h1>
<p>I remember trying to get Node to run on the Pi when I first got one and it really wasn&#39;t a fun journey, things seem to have changed (or my Google-foo has gotten better) and it&#39;s dead simple.</p>
<h1 id="install-node-and-npm">Install Node and NPM</h1>
<p>Best guide was from <a href="https://learn.adafruit.com/raspberry-pi-hosting-node-red/setting-up-node-dot-js">Adafruit</a>. These deb&#39;s are actually more up to date than the Pi builds available of the official NodeJS site.</p>
<p>For the basic guide:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt-get update
sudo apt-get upgrade

sudo wget http://node-arm.herokuapp.com/node_latest_armhf.deb

sudo dpkg -i node_latest_armhf.deb

node -v
</code></pre></div><h1 id="setup-hostname-for-pi">Setup hostname for Pi</h1>
<p>Once you have NodeJS installed (with NPM which installs with it), the obvious next thing is to build a server. I already had something super basic up and running and I wanted to access it locally on my network.</p>
<p>On the Pi itself I could access my Node site with http://localhost:3000/. I could even access this on computers on the local network by using the Raspberry Pi&#39;s IP address (For example <a href="http://192.168.0.xxx:3000)">http://192.168.0.xxx:3000)</a>.</p>
<p>What would be better is if I could have a URL like: http://myrpi/ and everything just started to work.</p>
<p>This is where the lovely gentleman that is <!-- raw HTML omitted -->Pete LePage<!-- raw HTML omitted --> helped me by telling me to install the avahi-daemon and then pointed out that I can access my sites with whatever is in the /etc/hosts file followed by <em>.local</em>.</p>
<p>Let&#39;s step through this and get it running.</p>
<ol>
<li>
<p>First install the daemon, which basically broadcasts the host on the local network.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt-get install avahi-daemon
</code></pre></div></li>
<li>
<p>Set a name in the /etc/hosts file, lets say myrpi.</p>
<ol>
<li>
<p>First open up the file to edit</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo nano /etc/hosts
</code></pre></div></li>
<li>
<p>At the bottom of our <em>/etc/hosts/</em> file add the following.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">127.0.1.1        myrpi
</code></pre></div></li>
</ol>
<p>This is simply an IP address that can be used to define the hostname for the machine.</p>
<ol start="3">
<li>Press <em>Ctrl+x</em> and then press <em>y</em> to save the file and exit nano.</li>
</ol>
</li>
<li>
<p>Ensure your Node server is running something, and if so, try out your URL in a browser by typing <em><a href="http://myrpi.local:3000/">http://myrpi.local:3000/</a></em>. If anything goes wrong, try rebooting your Pi.</p>
</li>
</ol>
<p>One side note of this. In my router I can define a hostname for each attached device, if I set the hostname to ‘myrpi’ I don&#39;t actually need to type in the <em>.local</em> part of the URL, in fact <em>http://myrpi:3000</em> is all that is needed.</p>
<h1 id="no-port-number--start-on-boot">No Port Number &amp; Start on Boot</h1>
<p>The next thing I wanted to do was have the Node server start up whenever I started up the Raspberry Pi. I did this by adding a script to <em>/etc/init.d/</em> which basically starts the Node server using <a href="https://github.com/nodejitsu/forever">forever</a>.</p>
<p>For those new to <em>forever</em> it&#39;s basically an node app which given a seperate Node script to run, it will start the script and run it forever, restarting it if it ever crashes.</p>
<p>To do this, the steps are as follows.</p>
<h2 id="install-forever-globally">Install forever globally.</h2>
<p>Install forever globally so that scripts can access it anywhere on the pi, you do this with the -g command.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo npm install -g forever
</code></pre></div><h2 id="create-your-startup-script">Create Your Startup Script</h2>
<p>I ended up using something similar to the script below, I try and explain each part afterwards.</p>
<pre><code>### BEGIN INIT INFO
# Provides:              &lt;name-of-script&gt;
# Required-Start:    $remote_fs $named $syslog
# Required-Stop:     $remote_fs $named $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: &lt;Short Description&gt;
# Description:       &lt;Longer Description&gt;
### END INIT INFO

#!/bin/bash

PATH=$PATH:/sbin:/usr/sbin:/bin:/usr/bin:/usr/local/bin
NODESCRIPT=&lt;Path to Script&gt;

case &#34;$1&#34; in
  start)
    # The -A indicates, adding of this rule
    sudo iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 3000
    sudo iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport 80 -j REDIRECT --to-port 3000
    sudo -u pi forever start $NODESCRIPT/cli.js
    ;;
  stop)
    sudo -u pi forever stop $NODESCRIPT/cli.js
    # The -D indicates, deleting of this rule
    sudo iptables -t nat -D PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 3000
    sudo iptables -t nat -D PREROUTING -i wlan0 -p tcp --dport 80 -j REDIRECT --to-port 3000
    ;;
  *)

  echo &#34;Usage: /etc/init.d/&lt;name-of-script&gt; {start|stop}&#34;
  exit 1
  ;;
esac
exit 0
</code></pre><h3 id="the-lsb-section">The LSB Section</h3>
<p>The <em>BEGIN INIT INFO</em> to <em>END INIT INFO</em> is essentially a specific format for init scripts which Debian looks for. I think it&#39;s used for dependency management.</p>
<p>You can find out more info <a href="https://wiki.debian.org/LSBInitScripts">on LSB Init Scripts on this page</a> if you&#39;re curious.</p>
<pre><code>### BEGIN INIT INFO
# Provides:              &lt;name-of-script&gt;
# Required-Start:    $remote_fs $named $syslog
# Required-Stop:     $remote_fs $named $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: &lt;Short Description&gt;
# Description:       &lt;Longer Description&gt;
### END INIT INFO
</code></pre><h3 id="bash-and-variables">Bash and Variables</h3>
<p>The second section declares the script as a bash script and appends some directories to the *$PATH * the script executes in and I also define the path of the Node script I want to run as <em>$NODESCRIPT</em>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
PATH<span style="color:#f92672">=</span>$PATH:/sbin:/usr/sbin:/bin:/usr/bin:/usr/local/bin
NODESCRIPT<span style="color:#f92672">=</span>&lt;Path to Script&gt;
</code></pre></div><h3 id="script-start">Script Start</h3>
<p>The script is designed to run with the command <em>sudo /etc/init.d/my-script start</em> or <em>sudo /etc/init.d/my-script stop</em>. In the next bit of the script we take the first variable from the command line, in this case it will be the <em>start</em> or <em>stop</em> text and if it&#39;s start we add two rules to the <em>iptables</em> and then start our Node script with <em>sudo forever start $NODESCRIPT/cli.js</em>.</p>
<p>There are a few things to step through for start.</p>
<ol>
<li>
<p>The <em>iptables</em> commands are the thing which makes requests on port 80, redirect to port 3000. What this means is when I type <em><a href="http://myrpi.local/">http://myrpi.local/</a></em> the request will arrive at the Pi on port 80, this rule then redirect from port 80 to port 3000. The reason we have two is because we need to do it for both ethernet and wifi connections. You might be able to cut this down into one.</p>
<p>If your router supports it, you can forward port 80 to port 3000 and avoid having to do any of this.</p>
</li>
<li>
<p>I&#39;ve run the forever script with <em>sudo -u pi</em>. The reason I&#39;ve done this, is otherwise forever starts the scripts under some unknown user, meaning I can&#39;t then stop the forever task reliably. If I use <em>sudo -u pi</em>, I can always run the stop command under pi, which has access to the forever task and can hence, stop it.</p>
</li>
</ol>
<pre><code>case &#34;$1&#34; in
  start)
    # The -A indicates, adding of this rule
    sudo iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 3000
    sudo iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport 80 -j REDIRECT --to-port 3000
    sudo -u pi forever start $NODESCRIPT/cli.js
    ;;
</code></pre><h3 id="the-final-step-to-stop-the-server">The Final Step to Stop the Server</h3>
<p>To stop the server, we do the reverse of the above. We stop the forever task and remove the iptable entries.</p>
<pre><code>stop)
  sudo -u pi forever stop $NODESCRIPT/cli.js
  # The -D indicates, deleting of this rule
  sudo iptables -t nat -D PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 3000
  sudo iptables -t nat -D PREROUTING -i wlan0 -p tcp --dport 80 -j REDIRECT --to-port 3000
  ;;
*)
</code></pre><p>The final bit of the script (shown below), simply prints out a message if you don&#39;t add a start or stop to the end of the command.</p>
<pre><code>echo &#34;Usage: /etc/init.d/&lt;name-of-script&gt; {start|stop}&#34;
exit 1
</code></pre><h2 id="moment-of-truth">Moment of Truth</h2>
<p>Check everything runs from the command line, no startup yet.</p>
<p>Save your script to <em>/etc/init.d/<!-- raw HTML omitted -->.sh</em> and make sure it&#39;s executable.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo chmod u+x /etc/init.d/&lt;startup-scrtipt-name&gt;.sh
</code></pre></div><p>Then try to start the server with the script.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo /etc/init.d/&lt;startup-scrtipt-name&gt;.sh start
</code></pre></div><p>If everything works as expect, test stopping the server.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo /etc/init.d/&lt;startup-scrtipt-name&gt;.sh stop
</code></pre></div><p>Everything will hopefully stop as you&#39;d expect and now you can <em>sudo reboot</em> and shortly after booting, you&#39;ll see your server start working.</p>
<h1 id="setup-for-dyndns-usage">Setup for DynDNS Usage</h1>
<p>After I got through all this, I really wanted to setup Dynamic DNS, originally I thought I wasn&#39;t bothered.</p>
<p>I went with <a href="http://www.noip.com/">noip.com</a>, you just need to set up a host and then configure some way of updating them with
Port Forwarding: <a href="https://www.namecheap.com/support/knowledgebase/article.aspx/9356/11/how-to-configure-a-ddwrt-router">https://www.namecheap.com/support/knowledgebase/article.aspx/9356/11/how-to-configure-a-ddwrt-router</a></p>
<p>Orig. Image: <a href="https://flic.kr/p/c1gNLw">https://flic.kr/p/c1gNLw</a></p>

</main>
<footer class="c-footer">
  <div class="c-footer__content">
    <a href="://twiter.com/gauntface">Twitter</a> | <a href="://github.com/gauntface">GitHub</a> | <a href="://www.linkedin.com/in/mattgaunt/">LinkedIn</a>
  </div>
</footer>
</div>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-155219449-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-155219449-1');
</script>

<script>var haCSS = haCSS || []; haCSS.push(...['/css/elements/code-async.css']);</script></body></html>