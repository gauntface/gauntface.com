<!DOCTYPE html><html lang="en"><head>
  <title>Your Guide to SSL on Nginx</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="Description" content="This is the site description"/>
  <meta name="theme-color" content="#565797"/>
<style>:root{--body-font-family:"Roboto",sans-serif;--code-font-family:"dm",monospace;--default-font-size:18px;--table-cell-padding:8px;--page-padding:24px;--header-padding:64px;--footer-padding:64px;--inline-code-padding:4px;--pre-padding:4px;--page-max-width:800px;--white:#f5f6fa;--dark-grey:#2f3640}html{height:100%;font-size:18px;font-size:var(--default-font-size)}</style><style>@import url("https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap");body{display:inline;min-height:100%;font-family:var(--body-font-family);background:var(--white);color:var(--dark-grey);margin:0}</style><style>a{color:inherit}</style><style>svg{display:block}</style><style>code{padding:0 var(--inline-code-padding);border-radius:var(--inline-code-padding);font-family:var(--code-font-family);background:var(--dark-grey);color:var(--white)}</style><style>img{max-width:100%;height:auto}</style><style>h2{font-weight:400;font-size:1.7rem}</style><style>h3{font-weight:400;font-size:1.4rem}</style><style>p{word-wrap:break-word}</style><style>h1{font-weight:400;font-size:2rem}</style><style>.l-default{display:flex;flex-direction:column;min-height:100%}.l-default__main{max-width:var(--page-max-width);margin:0 auto;flex:1;padding:var(--page-padding)}</style><style>.c-header{color:var(--platnum);padding:var(--header-padding) var(--page-padding);background:var(--dark-grey)}.c-header__logo svg{width:124px;height:124px;margin:auto}.c-header__logo svg path{fill:var(--white)}</style><style>pre{overflow-x:auto}</style><style>pre{background-color:var(--dark-grey);padding:var(--pre-padding);border-radius:var(--pre-padding);overflow-x:auto;box-shadow:0 2px 8px var(--drop-shadow)}pre code{padding:0;background:unset}</style><style>.c-footer{display:flex;flex-direction:row;justify-content:center}.c-footer__content{padding:var(--footer-padding)}.c-footer a{text-decoration:none}</style></head><body>
<div class="l-default">
  <header class="c-header">
  <a href="/" class="c-header__logo">
    <svg width="1024" height="1024" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M988 36H36V987H988V36ZM0 0V1023H1024V0H0Z" fill="black"></path>
<path d="M834.787 519.358H767.661V590H746.567V430.039H845.664V447.397H767.661V502.109H834.787V519.358Z" fill="black"></path>
<path d="M574.089 447.397H522.673V590H501.689V447.397H450.383V430.039H574.089V447.397Z" fill="black"></path>
<path d="M834.984 821.062H765.661V877.751H846.19V895H744.567V735.039H845.092V752.397H765.661V803.813H834.984V821.062Z" fill="black"></path>
<path d="M575.23 844.243C573.253 861.162 566.991 874.236 556.444 883.464C545.97 892.62 532.018 897.197 514.586 897.197C495.689 897.197 480.528 890.422 469.103 876.873C457.75 863.323 452.074 845.195 452.074 822.49V807.109C452.074 792.241 454.71 779.167 459.984 767.888C465.331 756.609 472.875 747.966 482.616 741.96C492.357 735.881 503.636 732.842 516.454 732.842C533.446 732.842 547.069 737.603 557.323 747.124C567.577 756.572 573.546 769.683 575.23 786.455H554.027C552.196 773.711 548.204 764.482 542.052 758.77C535.973 753.057 527.44 750.2 516.454 750.2C502.977 750.2 492.394 755.181 484.703 765.142C477.086 775.103 473.277 789.275 473.277 807.659V823.149C473.277 840.508 476.903 854.314 484.154 864.568C491.405 874.822 501.549 879.949 514.586 879.949C526.305 879.949 535.277 877.312 541.502 872.039C547.801 866.692 551.976 857.427 554.027 844.243H575.23Z" fill="black"></path>
<path d="M266.397 853.252H199.38L184.329 895H162.576L223.66 735.039H242.117L303.311 895H281.668L266.397 853.252ZM205.752 835.894H260.135L232.889 761.077L205.752 835.894Z" fill="black"></path>
<path d="M294.004 590H272.8L192.271 466.733V590H171.067V430.039H192.271L273.02 553.855V430.039H294.004V590Z" fill="black"></path>
<path d="M848.177 122.039V230.804C848.104 245.892 843.343 258.233 833.895 267.828C824.52 277.422 811.775 282.806 795.662 283.978L790.059 284.197C772.554 284.197 758.602 279.473 748.201 270.025C737.801 260.577 732.527 247.576 732.381 231.023V122.039H753.255V230.364C753.255 241.937 756.441 250.945 762.813 257.391C769.185 263.763 778.267 266.949 790.059 266.949C801.998 266.949 811.116 263.763 817.415 257.391C823.787 251.019 826.973 242.046 826.973 230.474V122.039H848.177Z" fill="black"></path>
<path d="M545.897 240.252H478.88L463.829 282H442.076L503.16 122.039H521.617L582.811 282H561.168L545.897 240.252ZM485.252 222.894H539.635L512.389 148.077L485.252 222.894Z" fill="black"></path>
<path d="M292.17 261.016C286.75 268.78 279.169 274.603 269.428 278.484C259.76 282.293 248.481 284.197 235.59 284.197C222.553 284.197 210.981 281.158 200.874 275.079C190.766 268.926 182.929 260.21 177.363 248.931C171.87 237.652 169.05 224.578 168.903 209.71V195.757C168.903 171.661 174.506 152.984 185.712 139.727C196.992 126.47 212.812 119.842 233.173 119.842C249.873 119.842 263.312 124.126 273.493 132.696C283.674 141.192 289.899 153.277 292.17 168.951H271.076C267.121 147.784 254.523 137.2 233.283 137.2C219.147 137.2 208.417 142.181 201.093 152.142C193.842 162.029 190.18 176.385 190.107 195.208V208.282C190.107 226.226 194.208 240.508 202.412 251.128C210.615 261.675 221.711 266.949 235.7 266.949C243.61 266.949 250.532 266.07 256.464 264.312C262.397 262.554 267.304 259.588 271.186 255.413V219.488H234.162V202.349H292.17V261.016Z" fill="black"></path>
</svg>

  </a>
</header>
  <main class="l-default__main">
<p><img src="/images/blog/2014/09/09/10248675643-d5ab02a636-o.jpg" alt="Key art for blog post “Your Guide to SSL on Nginx “"/></p>
<h1 id="your-guide-to-ssl-on-nginx">Your Guide to SSL on Nginx</h1>
<p>Looking to set up SSL on your site? Using Nginx to host? Then come on it.</p>
<h1 id="7-steps-to-ssl-bliss">7 Steps to SSL Bliss</h1>
<h2 id="1-get-a-certificate">1.) Get a Certificate</h2>
<p>Go over to <a href="https://www.namecheap.com/security/ssl-certificates/domain-validation.aspx">namecheap.com</a> and pick yourself up a nice little cert. The cheapest is about $9.00 (~£5.58)</p>
<h2 id="2-activate-your-certificate">2.) Activate your Certificate</h2>
<p>Once you&#39;ve bought your SSL Certificate, you need to activate it. <a href="https://www.namecheap.com/support/knowledgebase/article.aspx/794/67/how-to-activate-ssl-certificate">This page has all the info you need</a>. Ultimately, it&#39;s squirrelled away here.</p>
<p><img src="/images/blog/2014/09/09/ssl-menu-access.png" alt="NameCheap SSL Activation" title="630"/></p>
<p>The wizard will ask you to paste in a <em>Certificate Signing Request (CSR)</em>, which you&#39;ll either get from your host or if you are self-hosted, you can make one yourself with the following command:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">openssl req -nodes -newkey rsa:2048 -keyout private.key -out server.csr

    Country Name <span style="color:#f92672">(</span><span style="color:#ae81ff">2</span> letter code<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>AU<span style="color:#f92672">]</span>: GB
    State or Province Name <span style="color:#f92672">(</span>full name<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Some-State<span style="color:#f92672">]</span>: London
    Locality Name <span style="color:#f92672">(</span>eg, city<span style="color:#f92672">)</span> <span style="color:#f92672">[</span><span style="color:#f92672">]</span>: London
    Organization Name <span style="color:#f92672">(</span>eg, company<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Internet Widgits Pty Ltd<span style="color:#f92672">]</span>: Gauntface
    Organizational Unit Name <span style="color:#f92672">(</span>eg, section<span style="color:#f92672">)</span> <span style="color:#f92672">[</span><span style="color:#f92672">]</span>:
    Common Name <span style="color:#f92672">(</span>eg, YOUR name<span style="color:#f92672">)</span> <span style="color:#f92672">[</span><span style="color:#f92672">]</span>: subdomain.gauntface.com
    Email Address <span style="color:#f92672">[</span><span style="color:#f92672">]</span>:
    Please enter the following <span style="color:#e6db74">&#39;extra&#39;</span> attributes to be sent with your certificate request
    A challenge password <span style="color:#f92672">[</span><span style="color:#f92672">]</span>:
    An optional company name <span style="color:#f92672">[</span><span style="color:#f92672">]</span>:
</code></pre></div><p>This outputs a <em>server.csr</em> file as well as a <em>private.key</em>. Keep both of these files safe and back-them up.</p>
<p>Copy the contents of the <em>.csr</em> file into NameCheap&#39;s site. Afterwards you&#39;ll be asked to pick an email address linked to your domain (i.e. for me an example would be <a href="mailto:webmaster@gauntface.com">webmaster@gauntface.com</a>), pick one and move to the next step.</p>
<p><em>p.s. if you get message saying the email isn&#39;t valid, just double check you can get e-mails to it  and continue - I had to tell NameCheap to ignore this error</em></p>
<h2 id="3-sit-tight">3.) Sit Tight</h2>
<p>Wait until NameCheap sends you your certificates. For me this was maybe 15 - 30 minutes. <a href="http://xkcd.com/">Time to read this</a>.</p>
<h2 id="4-generate-the-nginx-certificates">4.) Generate the Nginx Certificates</h2>
<p>In your Nginx config file, there are a few certificates you&#39;ll need.</p>
<pre><code>ssl_certificate     /etc/ssl/certs/ssl-bundle.crt;
ssl_certificate_key /etc/ssl/private/private.key;

# Diffie-Hellman parameter for DHE ciphersuites, recommended 2048 bits
ssl_dhparam /etc/ssl/certs/dhparam.cert;

# OCSP Stapling
ssl_trusted_certificate /etc/ssl/certs/trusted-ssl-bundle.crt;
</code></pre><p>Let&#39;s step through how you make each one. Unzip the certificates you got from NameCheap.</p>
<h3 id="ssl_certificate--ssl-bundlecrt">ssl_certificate &gt; ssl-bundle.crt</h3>
<p><em>ssl-bundle.crt</em> is the combination of the following files from your NameCheap zip, in this order:</p>
<ul>
<li>domain_com.crt (in my case gauntface_com.crt)</li>
<li>COMODORSADomainValidationSecureServerCA.crt</li>
<li>COMODORSAAddTrustCA.crt</li>
<li>AddTrustExternalCARoot.crt</li>
</ul>
<p>You can create the <em>ssl-bundle.crt</em> by running the following command in the NameCheap directory.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat gauntface_com.crt COMODORSADomainValidationSecureServerCA.crt COMODORSAAddTrustCA.crt AddTrustExternalCARoot.crt &gt; ssl-bundle.crt
</code></pre></div><h3 id="ssl_certificate_key--privatekey">ssl_certificate_key &gt; private.key</h3>
<p>This one is easy. This is the private.key you made in step 1.</p>
<h3 id="ssl_dhparam--dhparamcert">ssl_dhparam &gt; dhparam.cert</h3>
<p>The Diffie-Hellman parameter is used to enable <a href="http://en.wikipedia.org/wiki/Forward_secrecy">forward secrecy</a>.</p>
<p>You can create this key with the following command.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">openssl dhparam -out dhparam.cert <span style="color:#ae81ff">2048</span>
</code></pre></div><h3 id="ssl_trusted_certificate--trusted-ssl-bundlecrt">ssl_trusted_certificate &gt; trusted-ssl-bundle.crt</h3>
<p>To create this certificate, I simply took the root certificate and intermediaries and concatenated them into a single file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat COMODORSADomainValidationSecureServerCA.crt COMODORSAAddTrustCA.crt AddTrustExternalCARoot.crt &gt; trusted-ssl-bundle.crt
</code></pre></div><h2 id="5-update-your-nginx-config">5.) Update Your Nginx Config</h2>
<p>The best advice I can give here is to use <a href="https://wiki.mozilla.org/Security/Server_Side_TLS#Apache">Mozilla&#39;s Wiki on the best config for your site</a>.</p>
<p>Using the Mozilla config file along with certificate files above, my config file, <em>at the time of writing</em>, looks like….</p>
<pre><code>server {
    listen       443 ssl spdy;
    server_name gauntface.com;

    # Turn on SSL
    ssl on;
    ssl_certificate     /etc/ssl/certs/ssl-bundle.crt;
    ssl_certificate_key /etc/ssl/private/private.key;

    # Recommended Cipher Suites from Mozilla Wiki
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;

    # See: https://wiki.mozilla.org/Security/Server_Side_TLS#Non-Backward_Compatible_Ciphersuite
    ssl_ciphers &#39;ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK&#39;;

    # Diffie-Hellman parameter for DHE ciphersuites, recommended 2048 bits
    ssl_dhparam /etc/ssl/certs/dhparam.cert;

    # Cache parameters for the SSL session
    ssl_session_timeout 5m;
    ssl_session_cache shared:SSL:50m;

    # OCSP Stapling
    # Fetch OCSP records from URL in ssl_certificate and cache them
    # Using Googles Public DNS 8.8.8.8
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/ssl/certs/trusted-ssl-bundle.crt;
    resolver 8.8.8.8;

    # Switch on Keep Alive
    keepalive_timeout   70;

    # HSTS Header for SSL
    # add_header Strict-Transport-Security &#34;max-age=31536000; includeSubdomains&#34;;
    add_header Strict-Transport-Security &#34;max-age=31536000;&#34;;

    # Include gzip - text/html isn&#39;t in the types as it in by default
    gzip on;
    gzip_comp_level 2;
    gzip_http_version 1.0;
    gzip_proxied any;
    gzip_min_length 1100;
    gzip_buffers 16 8k;
    gzip_types text/plain text/css application/x-javascript application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Disable for IE &lt; 6 because there are some known problems
    gzip_disable &#34;MSIE [1-6].(?!.*SV1)&#34;;

    # Add a vary header for downstream proxies to avoid sending cached gzipped files to IE6
    gzip_vary on;

    .........
</code></pre><p><em>Don&#39;t Forget!</em> to move all the SSL files into the right directories OR change the config files above.</p>
<ul>
<li>/etc/ssl/certs/ssl-bundle.crt</li>
<li>/etc/ssl/private/private.key</li>
<li>/etc/ssl/certs/trusted-ssl-bundle.crt</li>
<li>/etc/ssl/certs/dhparam.cert</li>
</ul>
<p>Things to note:</p>
<ul>
<li>I&#39;m using <a href="http://en.wikipedia.org/wiki/SPDY">Spdy</a>, new versions of Nginx have this on by default. If you run into trouble, then delete the <em>spdy</em> keyword, or even better, update Nginx by <a href="http://wiki.nginx.org/Install">using one of the official Nginx repos</a>.</li>
<li>I don&#39;t include subdomains in the HSTS header since I don&#39;t have a wildcard SSL certificate. If you do, then add subdomains.</li>
</ul>
<h2 id="6-redirect-traffic">6.) Redirect Traffic</h2>
<p>Once you have SSL working (i.e. <a href="https://yoursite.com">https://yoursite.com</a>) is working, you&#39;ll want to redirect people from HTTP to HTTPS.</p>
<p>For my config, I&#39;ve wanted to redirect .co.uk and .uk domains to my .com domain as well as handle the subdomain for my blog being from HTTP to HTTPS to a different URL structure.</p>
<p>The config is as follows.</p>
<pre><code># Redirect http://gauntface.com to https://gauntface.com
server {
    listen       80;
    server_name gauntface.com;
    return 301 &#34;https://gauntface.com${uri}&#34;;
}

# Redirect other domains and www
server {
    server_name www.gauntface.co.uk gauntface.co.uk www.gauntface.uk gauntface.uk www.gauntface.com;
    return 301 &#34;https://gauntface.com${uri}&#34;;
}

# Redirect blog sub domains
server {
    server_name blog.gauntface.com blog.gauntface.co.uk blog.gauntface.uk;
    return 301 &#34;https://gauntface.com/blog${uri}&#34;;
}
</code></pre><p>This is just for inspiration, you&#39;ll need to change this for your site.</p>
<h2 id="7-test">7.) Test</h2>
<p>There are a few tests you need to run on your site to make sure everything is A-Okay.</p>
<p>###<a href="https://www.ssllabs.com/ssltest/">SSLLabs</a></p>
<p>This checks for a tonne of features that you should have on your site now that you&#39;ve enabled SSL.</p>
<p><img src="/images/blog/2014/09/09/ssl-labs-test-results.png" alt="SSLLabs Test Results for Gauntface.com" title="600"/></p>
<h3 id="shaaaaaaaaaaaaacomhttpsshaaaaaaaaaaaaacom"><a href="https://shaaaaaaaaaaaaa.com/">shaaaaaaaaaaaaa.com</a></h3>
<p>This nifty little site checks that your site is using an SHA256 certificate. I believe this is sorted in step 1 where we create our private key and CSR file. The <em>-newkey rsa:2048</em> parameter is the bit which does it (or at least I think it does).</p>
<p><img src="/images/blog/2014/09/25/shaaaaa.png" alt="shaaaaaaa Test Results for Gauntface.com" title="600"/></p>
<h3 id="spdycheckorghttpspdycheckorg"><a href="http://spdycheck.org/">spdycheck.org</a></h3>
<p>If you use spdy, then you&#39;ll want to run your site through this, just to be sure everything is ok.</p>
<p><img src="/images/blog/2014/09/09/spdycheck-test.png" alt="SPDY Check Test Results for Gauntface.com" title="600"/></p>
<h1 id="final-comments">Final Comments</h1>
<p>I&#39;ve gone out of my way to avoid explaining what each part of the above config does for two reasons.</p>
<ol>
<li>I only have a base level understanding of what each piece is for and I&#39;m learning how wrong that understanding is every day.</li>
<li>I want you to focus on the sources to update your config and test your site.</li>
</ol>
<p>I hope this has been useful and if you find any issues, please let me know via <a href="https://gauntface.com/contact">twitter or email</a>.</p>
<p>Orig. Photo: <a href="https://flic.kr/p/gBD9dc">https://flic.kr/p/gBD9dc</a></p>

</main>
<footer class="c-footer">
  <div class="c-footer__content">
    <a href="://twiter.com/gauntface">Twitter</a> | <a href="://github.com/gauntface">GitHub</a> | <a href="://www.linkedin.com/in/mattgaunt/">LinkedIn</a>
  </div>
</footer>
</div>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-155219449-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-155219449-1');
</script>

<script>var haCSS = haCSS || []; haCSS.push(...['/css/elements/code-async.css']);</script></body></html>