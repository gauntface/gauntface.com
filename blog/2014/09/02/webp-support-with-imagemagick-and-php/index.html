<!DOCTYPE html><html lang="en"><head>
  <title>WebP Support with ImageMagick and PHP</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="Description" content="This is the site description"/>
  <meta name="theme-color" content="#565797"/>
<style>:root{--body-font-family:"Roboto",sans-serif;--code-font-family:"dm",monospace;--default-font-size:18px;--table-cell-padding:8px;--page-padding:24px;--header-padding:64px;--white-smoke:#f7f7f7;--platnum:#e5dedf;--dust-storm:#e5c9cf;--pale-chestnut:#e5a9b4;--liberty:#565797;--dark-slate-blue:#434596;--lightest:#d0d0d0;--light:#bfc7d4;--muted-light:#747a88;--muted:#434757;--dark:#292d3d;--black:#272729;--drop-shadow:rgba(39,39,41,0.4);--red:#ee727a;--green:#c4e791;--yellow:#feca72;--blue:#84acfc;--purple:#c694e8;--light-blue:#8cddfd}html{height:100%;font-size:18px;font-size:var(--default-font-size)}</style><style>.l-default{display:flex;flex-direction:column;min-height:100%}.l-default__main{flex:1;padding:var(--page-padding)}</style><style>h1{font-size:2rem}</style><style>pre{overflow-x:auto}</style><style>pre{background-color:var(--dark);color:var(--light);padding:12px;overflow-x:auto;border-radius:12px;box-shadow:0 2px 8px var(--drop-shadow)}pre code{padding:0;background:unset}</style><style>.c-footer{display:flex;flex-direction:row}.c-footer__corner{flex:1}.c-footer__corner svg{display:block;width:80%;height:100%;margin-left:auto}.c-footer__content{flex:2;margin-left:auto;background:var(--liberty)}@media (min-width:1000px){.c-footer{width:80%;margin-left:auto}}</style><style>.c-header{color:var(--platnum);padding:var(--header-padding) var(--page-padding);background:var(--liberty)}.c-header__logo svg{width:124px;height:124px;margin:auto}.c-header__logo svg path{fill:var(--platnum)}</style><style>svg{display:block}</style><style>p{word-wrap:break-word}</style><style>@import url("https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap");body{display:inline;min-height:100%;font-family:var(--body-font-family);background:var(--platnum);margin:0}</style><style>code{padding:0 4px;font-family:var(--code-font-family);background:var(--pale-chestnut)}</style><style>img{max-width:100%;height:auto}</style></head><body>
<div class="l-default">
  <header class="c-header">
  <a href="/" class="c-header__logo">
    <svg width="1024" height="1024" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M988 36H36V987H988V36ZM0 0V1023H1024V0H0Z" fill="black"></path>
<path d="M834.787 519.358H767.661V590H746.567V430.039H845.664V447.397H767.661V502.109H834.787V519.358Z" fill="black"></path>
<path d="M574.089 447.397H522.673V590H501.689V447.397H450.383V430.039H574.089V447.397Z" fill="black"></path>
<path d="M834.984 821.062H765.661V877.751H846.19V895H744.567V735.039H845.092V752.397H765.661V803.813H834.984V821.062Z" fill="black"></path>
<path d="M575.23 844.243C573.253 861.162 566.991 874.236 556.444 883.464C545.97 892.62 532.018 897.197 514.586 897.197C495.689 897.197 480.528 890.422 469.103 876.873C457.75 863.323 452.074 845.195 452.074 822.49V807.109C452.074 792.241 454.71 779.167 459.984 767.888C465.331 756.609 472.875 747.966 482.616 741.96C492.357 735.881 503.636 732.842 516.454 732.842C533.446 732.842 547.069 737.603 557.323 747.124C567.577 756.572 573.546 769.683 575.23 786.455H554.027C552.196 773.711 548.204 764.482 542.052 758.77C535.973 753.057 527.44 750.2 516.454 750.2C502.977 750.2 492.394 755.181 484.703 765.142C477.086 775.103 473.277 789.275 473.277 807.659V823.149C473.277 840.508 476.903 854.314 484.154 864.568C491.405 874.822 501.549 879.949 514.586 879.949C526.305 879.949 535.277 877.312 541.502 872.039C547.801 866.692 551.976 857.427 554.027 844.243H575.23Z" fill="black"></path>
<path d="M266.397 853.252H199.38L184.329 895H162.576L223.66 735.039H242.117L303.311 895H281.668L266.397 853.252ZM205.752 835.894H260.135L232.889 761.077L205.752 835.894Z" fill="black"></path>
<path d="M294.004 590H272.8L192.271 466.733V590H171.067V430.039H192.271L273.02 553.855V430.039H294.004V590Z" fill="black"></path>
<path d="M848.177 122.039V230.804C848.104 245.892 843.343 258.233 833.895 267.828C824.52 277.422 811.775 282.806 795.662 283.978L790.059 284.197C772.554 284.197 758.602 279.473 748.201 270.025C737.801 260.577 732.527 247.576 732.381 231.023V122.039H753.255V230.364C753.255 241.937 756.441 250.945 762.813 257.391C769.185 263.763 778.267 266.949 790.059 266.949C801.998 266.949 811.116 263.763 817.415 257.391C823.787 251.019 826.973 242.046 826.973 230.474V122.039H848.177Z" fill="black"></path>
<path d="M545.897 240.252H478.88L463.829 282H442.076L503.16 122.039H521.617L582.811 282H561.168L545.897 240.252ZM485.252 222.894H539.635L512.389 148.077L485.252 222.894Z" fill="black"></path>
<path d="M292.17 261.016C286.75 268.78 279.169 274.603 269.428 278.484C259.76 282.293 248.481 284.197 235.59 284.197C222.553 284.197 210.981 281.158 200.874 275.079C190.766 268.926 182.929 260.21 177.363 248.931C171.87 237.652 169.05 224.578 168.903 209.71V195.757C168.903 171.661 174.506 152.984 185.712 139.727C196.992 126.47 212.812 119.842 233.173 119.842C249.873 119.842 263.312 124.126 273.493 132.696C283.674 141.192 289.899 153.277 292.17 168.951H271.076C267.121 147.784 254.523 137.2 233.283 137.2C219.147 137.2 208.417 142.181 201.093 152.142C193.842 162.029 190.18 176.385 190.107 195.208V208.282C190.107 226.226 194.208 240.508 202.412 251.128C210.615 261.675 221.711 266.949 235.7 266.949C243.61 266.949 250.532 266.07 256.464 264.312C262.397 262.554 267.304 259.588 271.186 255.413V219.488H234.162V202.349H292.17V261.016Z" fill="black"></path>
</svg>

  </a>
</header>
  <main class="l-default__main">
<p><img src="/images/blog/2014/07/25/5849354012-74dfc121e9-o.jpg" alt="Key art for blog post “WebP Support with ImageMagick and PHP “"/></p>
<h1 id="webp-support-with-imagemagick-and-php">WebP Support with ImageMagick and PHP</h1>
<p>I&#39;ve been wanting to get WebP set-up on my site for a little while now, the biggest barrier to entry has been getting it integrated into the flow already had, where I generate different sized images where I need to.</p>
<p>It turns out you can use ImageMagick <em>if</em> it can find  <em>libwebp-dev</em> when it&#39;s built.</p>
<p>By default, unfortunately, Ubuntu doesn&#39;t come with ImageMagick built with WebP support and I&#39;m assuming the same is true for Debian (I got everything working on Ubuntu and went through the same process on Debian - didn&#39;t check Debian needed this, I just assumed).</p>
<p>Anyway, I stumbled on this post which outlines how you can build webp support into ImageMagick.</p>
<p><a href="http://askubuntu.com/questions/251950/imagemagick-convert-cant-convert-to-webp">http://askubuntu.com/questions/251950/imagemagick-convert-cant-convert-to-webp</a></p>
<h1 id="check-your-version">Check Your Version</h1>
<p>After landing WebP I ended up hitting a problem later on where the alpha channel was messed up somewhere in the WebP conversion and displayed a black background - Booooo.</p>
<p>Turns out this is <a href="http://www.imagemagick.org/discourse-server/viewtopic.php?f=3&amp;t=22793&amp;p=95304&amp;hilit=webp+alpha+webp#p95304">a bug in ImageMagick</a>.</p>
<p>The way to get around the problem is to install a version higher than or equal to 6.8.3-0 Beta. This may be an option for you using the information on <a href="http://www.imagemagick.org/discourse-server/viewtopic.php?f=1&amp;t=24284#p105786">this ImageMagick post</a>. The problem here, is that to compile newer versions of ImageMagick you need to have version 0.3.0 or higher of libwebp. Debian (and possibly) Ubuntu ships with 0.1.3. You can check yours with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo aptitude versions libwebp-dev
</code></pre></div><p>What to do? Well I bailed at this point. The code is sat on my server, but disabled by a boolean. When I get a newer version of ImageMagick or libwebp I will update everything and see if enabling it works or not.</p>
<h1 id="adding-webp-support-to-imagemagick">Adding WebP Support to ImageMagick</h1>
<p>To support WebP conversion in ImageMagick I had to install <em>libwebp-dev</em> with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt-get install libwebp-dev
</code></pre></div><p>Then it was a case of rebuilding ImageMagick.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd /tmp
mkdir imagemagick
cd imagemagick
sudo apt-get build-dep imagemagick
sudo apt-get install libwebp-dev devscripts
sudo apt-get install graphicsmagick-imagemagick-compat
apt-get source imagemagick
cd imagemagick-*
debuild -uc -us
sudo dpkg -i ../*magick*.deb
</code></pre></div><p>This all seemed to work, although I did get some weird/scary looking error messages after the final command.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Errors were encountered <span style="color:#66d9ef">while</span> processing:
    ../imagemagick_6.7.7.10-5+deb7u3_amd64.deb
    imagemagick-dbg
    libmagickcore-dev
    libmagickwand-dev
    libmagick++-dev
</code></pre></div><p>What I ended up doing to get around this was run the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt-get -f install
sudo dpkg -i ../imagemagick_6.7.7.10-5+deb7u3_amd64.deb
</code></pre></div><h1 id="web-page-test">Web Page Test</h1>
<p>I ran everything through <a href="http://webpagetest.org">WebPageTest.org</a> and WebP has a positive impact on my site (surprise, surprise).</p>
<p>On the home page the image went from 141.5 KB to 66.8 KB and that results in a load time from 959 ms to 393 ms.</p>
<p>You can see the difference in the results below.</p>
<p><a href="http://www.webpagetest.org/result/140725_0J_YC8/">WebPageTest Results Before WebP</a></p>
<p><a href="http://www.webpagetest.org/result/140725_JH_YQA/">WebPageTest Results After WebP</a></p>
<h1 id="how-do-you-convert-to-webp">How Do You Convert to WebP?</h1>
<p>One thing I do on my site is format the file names in the URL in such a way that it includes the desired image dimensions as well as the density of the screen.</p>
<p>This means I can decide what size image I send to the browser.</p>
<p>For that reason, I got ImageMagick to do a couple of extra things, other than just convert, it strips the images metadata, crops it and then resizes it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">function resizeAndConvertImageWebP(
    $width,
    $height,
    $density,
    $originalFilepath,
    $resizedFilepath) {
  $newWidth = $width * $density;
  $newHeight = $height * $density;

  $image = new Imagick($originalFilepath);
  $origImageDimens = $image-&gt;getImageGeometry();
  $origImgWidth = $origImageDimens[&#39;width&#39;];
  $origImgHeight = $origImageDimens[&#39;height&#39;];

  if($newWidth == 0) {
    $ratioOfHeight = $newHeight / $origImgHeight;
    $newWidth = $origImgWidth * $ratioOfHeight;
  }

  if($newHeight == 0) {
    $ratioOfWidth = $newWidth / $origImgWidth;
    $newHeight = $origImgHeight * $ratioOfWidth;
  }

  $widthRatios = $origImgWidth / $newWidth;
  $heightRatios = $origImgHeight / $newHeight;

  if($widthRatios <span style="color:#960050;background-color:#1e0010">&lt;</span>= $heightRatios) {
    $cropWidth = $origImgWidth;
    $cropHeight = $newWidth * $widthRatios;
  } else {
    $cropWidth = $newHeight * $heightRatios;
    $cropHeight = $origImgHeight;
  }

  $cropX = ($origImgWidth - $cropWidth) / 2;
  $cropY = ($origImgHeight - $cropHeight) / 2;

  $image-&gt;stripImage();
  $image-&gt;cropImage($cropWidth, $cropHeight, $cropX, $cropY);
  $image-&gt;resizeImage($newWidth, $newHeight, imagick::FILTER_LANCZOS, 0.9);
  $image-&gt;setImageFormat(&#39;webp&#39;);
  $image-&gt;setImageAlphaChannel(imagick::ALPHACHANNEL_ACTIVATE);
  $image-&gt;setBackgroundColor(new ImagickPixel(&#39;transparent&#39;));
  $image-&gt;writeImage($resizedFilepath);
}
</code></pre></div><p>The important lines of code for WebP conversion are:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$image-&gt;setImageFormat(&#39;webp&#39;);
$image-&gt;setImageAlphaChannel(imagick::ALPHACHANNEL_ACTIVATE);
$image-&gt;setBackgroundColor(new ImagickPixel(&#39;transparent&#39;));
</code></pre></div><p>This defines the final image format to WebP and then ensures that if you are converting a PNG, it keeps any alpha channels.</p>
<h1 id="apache-gd-method-for-webp-conversion">Apache GD Method for WebP Conversion</h1>
<p>The Apache GD library can actually handle WebP as well  and this was going to be my original approach, however some issues in the library caused it to incorrectly pad the file so it fails to render.</p>
<p>More info here: <a href="https://bugs.php.net/bug.php?id=66590">https://bugs.php.net/bug.php?id=66590</a></p>
<p>If that wasn&#39;t an issue, the basic code would look something like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$im = $this-&gt;imageCreateFromAny($originalFilepath);
if(!$im) {
    // Unrecognized format
    return false;
}

imagewebp($im, $resizedFilepath);
imagedestroy($im);
</code></pre></div><p>Where imageCreateFromAny is a method I found from <a href="http://php.net/manual/en/function.imagecreatefromjpeg.php">this PHP Doc</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">function imageCreateFromAny($filepath) {
  $type = exif_imagetype($filepath); // [] if you don&#39;t have exif you could use getImageSize()
  $allowedTypes = array(
    1,  // [] gif
    2,  // [] jpg
    3,  // [] png
    6   // [] bmp
  );
  if (!in_array($type, $allowedTypes)) {
    return false;
  }
  switch ($type) {
    case 1 :
      $im = imageCreateFromGif($filepath);
      break;
    case 2 :
      $im = imageCreateFromJpeg($filepath);
      break;
    case 3 :
      $im = imageCreateFromPng($filepath);
      break;
    case 6 :
      $im = imageCreateFromBmp($filepath);
      break;
  }
  return $im;
}
</code></pre></div><h1 id="detecting-webp-support-or-not">Detecting WebP Support or Not</h1>
<p>Browsers which support WebP will include an accept header for ‘image/webp’ which I just look for and take that as a go ahead to serve up WebP.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">// Do we support WebP?
$webpsupport = (strpos($_SERVER[&#39;HTTP_ACCEPT&#39;], &#39;image/webp&#39;) &gt;= 0);
if($webpsupport) {
  $this-&gt;attemptToServeWebP($pathinfo, $matches, $width, $height, $density);
} else {
  $this-&gt;attemptToServeNormal($pathinfo, $matches, $width, $height, $density);
}
</code></pre></div><h1 id="useful-tid-bit">Useful Tid-Bit</h1>
<p>If you need to delete all of your auto generated WebP files for some reason, this will delete all of them from your current directory (including sub-directories).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo find . -type f -iname <span style="color:#ae81ff">\*</span>.webp -delete
</code></pre></div><h1 id="conclusion">Conclusion</h1>
<p>WebP is pretty cool for shaving off some extra page weight and it&#39;s not too bad to support if you have some kind of image generation in place already.</p>
<p>If not, then it may be worth looking for a Grunt or Gulp task to do it.</p>
<p>Grunt has <a href="https://github.com/somerandomdude/grunt-webp">grunt-webp</a></p>
<p>Gulp has <a href="https://github.com/sindresorhus/gulp-webp">gulp-webp</a></p>
<p>Orig Photo: <a href="https://flic.kr/p/9UTtaf">https://flic.kr/p/9UTtaf</a></p>

</main>
<footer class="c-footer">
  <div class="c-footer__corner">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 135.467 135.467" preserveAspectRatio="none"><path d="M135.467 135.467h-82.55L134.937 0h.53z" fill="#565797"></path><path d="M135.07 0L53.049 135.467H39.688L121.707 0z" fill="#feca72"></path><path d="M121.84 0L39.82 135.467H26.458L108.48 0z" fill="#c4e791"></path><path d="M108.611 0l-82.02 135.467H13.229L95.25 0z" fill="#84acfc"></path><path d="M95.382 0l-82.02 135.467H0L82.02 0z" fill="#ee727a"></path></svg>
  </div>
  <div class="c-footer__content"></div>
</footer>
</div>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-155219449-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-155219449-1');
</script>

<script>var haCSS = haCSS || []; haCSS.push(...['/css/elements/code-async.css']);</script></body></html>